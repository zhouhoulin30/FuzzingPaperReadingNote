# Fuzzing: Challenges and Reflections

​		我们总结了在湘南会议上研究人员和从业者的讨论中出现的模糊化和符号化执行的开放挑战和机遇，并在随后的调查中得到了验证。

​		互联网和世界数字经济运行在一个共享的、关键的开源软件基础设施上。单个库中的安全漏洞可能会产生严重后果。例如，OpenSSL实现了用于安全通信的协议，并被包括大多数HTTPS网站在内的互联网服务器广泛使用。OpenSSL早期版本中的Heartbleed漏洞会泄露机密数据并造成巨大的财务损失。对于我们来说，开发实用有效的技术来自动和大规模地发现漏洞是非常重要的。今天，模糊化是这方面最有前途的技术之一。模糊是一种自动错误和漏洞发现技术，它不断生成输入并报告导致程序崩溃的输入。有三种主要的模糊工具和技术：黑盒模糊、灰盒模糊和白盒模糊。

​		黑盒模糊生成的输入不需要任何程序知识。黑匣子模糊有两种主要变体：基于变异的和基于生成的。在基于变异的黑盒模糊测试中，模糊活动以一个或多个种子输入开始。这些种子被修改以产生新的输入。随机突变应用于输入中的随机位置。例如，文件模糊器可以翻转种子文件中的随机位。这个过程一直持续到时间预算耗尽。在基于生成的黑盒模糊测试中，输入是从头开始生成的。如果提供了输入格式的结构规范，则会生成符合语法的新输入。Peach（http://community.pachfuzzer.com）是一个流行的黑盒模糊器。

​		灰盒模糊器充分利用程序插桩来获得轻量级反馈，用于控制模糊器。通常，程序中的几个控制位置在编译时插入指令，并提供初始种子语料库。种子输入被变异以生成新的输入。生成的输入覆盖新控制位置，因此增加了代码覆盖率，被添加到了种子语料库中。覆盖率反馈允许灰盒模糊器逐渐深入代码。为了识别错误和漏洞，sanitizers会向程序中注入断言（可以理解为sanitizer的插桩）。现有的灰盒模糊工具包括AFL，LibFuzzer和Honggfuzz。

​		白盒模糊测试基于一种名为符号执行的技术，它使用程序分析和约束求解器系统地枚举感兴趣的程序路径。在白盒模糊化中用作后端的约束求解器是可满足模理论（SMT）求解器，它允许推理具有等式的（无量词的）一阶逻辑公式以及取自不同背景理论的函数/谓词符号。白盒模糊器计算输入i的路径条件，该组输入与i的路径相同。路径条件表示为SMT公式，例如：`i[0] = 42^i[0]-i[1]>7`。

​		给定种子输入s，计算并改变路径条件（与改变程序输入相反）。然后将变异路径条件发送到约束求解器以生成新的输入。该技术的主要好处是，通过仔细跟踪迄今为止看到的所有输入的路径条件，它总是生成一个遍历新路径的输入（新控制流）。现有的白盒模糊工具包括KLEE和SAGE。

​		在这篇文章中，我们反思了该领域的最新进展以及未来研究的具体方向。我们从从业者和研究者的角度讨论了最近的影响并列举了公开的研究挑战。有关详细的技术评论，我们请读者参阅Godefroid。

## 最近的影响

​		 利用模糊测试进行自动化的程序错误发现和漏洞挖掘已经席卷了软件行业和研究界。通过自动输入生成在程序中发现错误的研究问题由来已久，早在1990年米勒提出“模糊”一词之前就已经开始了，然而，直到现在，我们才看到模糊技术在产业中的主流部署。

​		使用灰盒模糊测试，谷歌过去八年中在Chrome浏览器中发现了16000多个bug，过去三年中在160多个开源软件项目中发现了11000多个Bug。微软认为其白盒模糊工具SAGE在Windows 7的开发过程中节省了数百万美元。Trail of Bits一直在开发各种模糊化工具，包括DeepState，一个单元测试框架，允许开发人员对系统的各个单元进行模糊化。2016年DARPA网络大挑战通过利用软件漏洞和加固来让机器之间进行攻防对抗。因为赢得比赛而获得200万美元奖金的Mayhem系统广泛使用了白盒模糊测试。

​		是什么使得大家最近对模糊测试的兴趣激增？首先，有巨大的需求。软件系统越来越多地渗透到生活和商业中，即使是最小的系统中的安全漏洞也会带来可怕的后果。其次，我们现在有了激励和所需的心态。一些软件公司已经建立了利润丰厚的漏洞奖励计划，为关键漏洞支付高额奖金。任何人，包括读者，都可以在漏洞奖励平台上提供漏洞奖励，例如HackerOne，这提供了道德协调和负责任的披露。独立的安全研究人员可以报告发现的漏洞并收集赏金。一些利益相关者将关键事情掌握在自己的手中，有几家公司不断模糊测试自己的软件。

​		第三，我们现在有了工具。许多fuzzer是开源的，免费可用，易于使用，并且在发现bug方面非常成功。例如，KLEE符号执行引擎已经免费提供、维护并广泛使用了10多年。因此，百度、富士通和三星等几家公司都使用并扩展了它来测试他们的软件产品。同样，AFL灰盒模糊器非常有效且易于使用。它的获奖案例包括大量开源系统中发现的bug和安全漏洞。

​		最后，这种开放的科学方法以及工业界和学术界之间的有意义的接触促进了模糊化的快速发展。例如，模糊器的速度越来越快，发现了更多类型的错误，并为更多的应用程序域工作。

## 挑战

​		2019年9月，我们在日本湘南国际村中心组织了一次关于模糊和符号执行的湘南会议。会议汇集了思想领袖、杰出的研究人员、工具建设者、创始人，以及来自灰色和白色模糊（符号执行）社区的有前途的年轻科学家。接下来，我们将讨论会议期间确定的主要挑战。我们将这些挑战称为研究问题，并希望它们能提供指导和前进方向。

## 自动化

​		自动漏洞发现是对手之间的游戏。给定相同的资源，使用模糊器的一方在发现更多的漏洞上更具优势。

### 更多的软件

​		我们如何有效地模糊更多类型的软件系统？我们已经知道如何模糊命令行工具(AFL和KLEE)和应用程序编程接口(APIs)、(LibFuzzer)。模糊器生成输入并观察程序的输出。社区正在积极研究如何模糊化接受高度结构化输入的程序，如文件解析器或面向对象程序。

​		社区正在积极研究如何模糊化接受高度结构化输入的程序，如文件解析器或面向对象程序。然而，模糊网络物理系统（作为其执行的一部分与环境交互）或机器学习系统（其行为由其训练数据决定）是一个未被探索的领域。

​		我们如何模糊有状态软件，比如为相同的输入产生不同输出的协议源码。大多数灰盒和白盒模糊器都是用单一编程语言编写的。我们如何对用多种语言编写的多语言软件进行模糊处理？我们如何模糊化基于GUI的程序，这些程序将在用户界面上执行的一系列事件作为输入？对于白盒模糊，我们已经知道符号执行如何在数字或基于字符串的输入域上形成约束。然而，给定一个输入域由语法或协议定义的程序，符号执行工具如何有效地对这种“结构化”输入域制定约束？

### 更多的bug类型

​		模糊器如何识别更多类型的漏洞？目前关于模糊化的大部分工作都集中在简单的预言上，比如寻找崩溃。我们需要研究不表现为崩溃的比较严重的安全类bug，并且开发能够有效检测它们的预测工具。漏洞通常被编码为对程序状态的断言。**(断言(assertion)是一种在程序中的一阶逻辑(如：一个结果为真或假的逻辑判断式)，目的为了表示与验证软件开发者预期的结果——当程序执行到断言的位置时，对应的断言应该为真。若断言不为真时，程序会中止执行，并给出错误信息。)**使用这样的断言，我们已经知道如何发现与内存或并发相关的错误。发现侧信道漏洞，如信息泄漏或延时、缓存或与能量相关的侧信道，目前是一个活跃的研究课题。展望未来，我们应该发明新的技术，不仅在C/C++中，而且可以在其他的编程语言中，自动地检测并调用权限提升、远程代码执行和其他类型的关键漏洞。

### 更困难的bug

​		我们如何才能找到“深层bug”，虽然存在有效的检测工具，但却无法发现它们？尽管进行了长时间的模糊测试活动，但仍有一些bug无法被发现，例如，因为它们受到复杂条件的保护，或者因为现有技术需要不切实际的资源才能找到它们。是否有某些类型的深层bug可以通过专门的方法有效地发现？**结构感知和基于语法的模糊测试**以及**静态分析和符号执行与灰盒模糊测试的集成**是很有前途的方向。 第二，软件也是一直在变化的，**针对软件补丁的技术**在被引入后将被证明在发现bug方面至关重要。第三，我们应该**研究加速寻找bug的策略**，例如AFLFast，它能够在灰盒模糊测试器更快地检测crash，并**研究GPU和其他有效并行手段的效用，以最大化每单位时间的执行次数**。最后，**根据bug的重要性对bug进行排序**也可以提高实践中模糊化的有效性。

### 更多实证研究

​		尽管模糊测试已经流行了很长时间，但仍未被发现的漏洞的性质是什么？为什么它们没有被发现？我们需要实证研究来了解源代码中安全漏洞的性质和分布。

## 人为因素

### 人机回环的方法

**(Human-in-the-Loop Approach)**

> ​		人机回圈 （Human-in-the-loop, HITL, 也译作人机回环）是一种人与机器的交互方式。最初从人机交互的角度，将自动化的问题重新定义为[人机交互](https://baike.baidu.com/item/人机交互/61313?fromModule=lemma_inlink)（Human-Computer Interaction，[HCI](https://baike.baidu.com/item/HCI/4436882?fromModule=lemma_inlink)）设计问题。随着人工智能的演进和应用，通过结合传统的 [BPM](https://baike.baidu.com/item/BPM/1933?fromModule=lemma_inlink) 流程设计后，人机回圈成为构建新一代以人为中心 (Human-centric) 的[自动化](https://baike.baidu.com/item/自动化/323170?fromModule=lemma_inlink)流程构建思路。意为将个人（专家，员工，业务人员）的判断，融入AI系统流程中去。构成流程的运行闭环。支持以相对固定的步骤和状态重复运行。

​		 模糊器如何利用审计人员的聪明 才智？许多研究人员认为模糊测试是一个完全自动化的过程，只有在（开始）软件系统为模糊器做好准备时，以及在（结束）模糊器发现需要报告的漏洞时，才会需要人的参与。实际上，**安全审计人员以迭代的方式使用模糊器**。在我们的会议期间，Ned Williamson，谷歌的一名经验丰富的安全研究员，演示了他的**半自动漏洞发现方法**。威廉姆森**首先会进行代码审计**，以识别**可能存在安全漏洞的单元**。他将为这个单元做模糊测试的准备，运行模糊器一段时间，然后**识别模糊器的路障**（可理解为很难满足的if条件）。他会**手动修复路障**，来帮助模糊器更好地运行。如果模糊器花费更多的时间模糊测试代码中不太相关的部分，他会调整测试驱动程序并让模糊器重新聚焦。一旦发现潜在的漏洞，他就会回溯，重新添加每个障碍，并相应地调整漏洞暴露输入。（**理解为一个紧缩的路径，fuzzer很难生成满足条件的输入，先人工绕过去，等到触发了crash，然后就回溯到刚才的路径障碍处，添加上之前的条件判断，然后根据crash构造输入**）

​		这个半自动化的过程提出了几个研究问题。我们如何促进模糊器和安全审计人员之间更有效的交流（通信、交互）？安全审计员如何动态地指导模糊器？模糊器如何解释是什么阻碍了它的运行，审计人员如何指导模糊器克服路障？

###  可用性

​		我们如何提高模糊工具的可用性？黑客需要一套非常特殊的技能。模糊测试已经简化了过程，至少在自动化的测试输入生成方面。我们**如何让开发人员和软件工程师更容易地使用模糊测试**。我们**如何更容易地为模糊器开发测试驱动程序**。 我们**如何将模糊测试集成到日常开发过程中**，例如，是作为连续集成流水线的一个组件，还是作为IDE中的模糊驱动单元测试工具？特别是，我们的行业参与者和客户认可的可用性是最重要的。

​		考虑人力的消耗，我们该**如何准备模糊器的输出**？模糊器产生的输入会使程序崩溃，开发人员必须找出它崩溃的原因。我们如何扩展fuzzer，**以便它为每个已识别的漏洞生成详细的bug报告甚至bug修复**？最近出现的自动修复技术可以在这方面有所帮助。最近关于Linux内核模糊测试的工作讨论了在企业Linux发行版上部署内核模糊器syzkaller时解决可用性挑战的技术。**将这种增强功能推广到通用软件的模糊器仍然是一个挑战**。

## 模糊测试理论

​		任何学科都必须建立在坚实的科学基础上。我们看到了模糊工具的工程上面有许多技术进步。但为什么有些模糊器比其他的效果更好呢？它们有什么局限性呢？我们希望能够解释我们根据经验观察到的有趣现象，做出预测，并从这些观察中推断。为此，我们需要一个完善的模糊测试过程理论模型。

### 剩余风险

​		如果模糊测试不成功，我们如何评估剩余安全风险？黑白盒模糊测试是两个极端。一个白盒模糊器可以提供一个关于不存在可检测漏洞的正式保证。如果我们假设符号执行引擎可以枚举一段代码中的所有路径并且预测被编码为断言，那么白盒模糊可以正式验证是否存在错误。如果它在合理的时间内只能列举一些路径，我们仍然可以提供部分保证。为了使符号执行在实践中适用，需要以正确性或完整性换取可伸缩性。这种权衡如何影响最后的结果保证？

​		相比之下，黑盒模糊器永远不能保证所有输入都没有漏洞。在一次模糊测试结束后，程序中仍有未被发现的bug的剩余风险是什么？如果我们将黑盒模糊测试建模为来自程序输入空间的随机抽样，我们可以利用应用统计的方法来估计剩余风险。

​		灰盒模糊器使用程序反馈来提高查找错误的效率。然而，该程序反馈引入一种自适应偏差。在评估剩余风险时，我们如何解释这种适应性偏差？为了回答这些问题，我们应该制定统计和概率的框架与方法，以便用一种可量化的准确性进行合理估计。

### 理论局限性

​		黑盒、灰盒、白盒模糊测试的理论局限性是什么？黑盒和灰盒模糊器效率很高，但以有效性为代价。与白盒模糊器不同，它们很难生成使用很少输入路径的输入。这种紧张关系引发了几个研究问题。给定一个程序和一个时间预算，我们该如何选择模糊测试技术或者组合技术，在时间预算内找到最多的漏洞。程序大小和复杂性如何影响每种技术的可伸缩性和性能？拥有更多数量级计算资源的攻击者的效率要高多少？了解现有方法的局限性后，我们可以开发更先进的技术。

## 评估和基准

​		为了验证新型模糊工具和技术的优越性，我们需要完善的评估方法。一般来说，更好的fuzzer会在合理的时间内发现我们关心的软件中的大量重要bug。但什么是“合理的时间”、“我们关心的软件”或“重要的错误”。如果没有发现重要的错误，我们如何衡量有效性？我们如何防止过度拟合？什么是公平的比较基准？

​		为了衡量进展，我们需要制定合理的标准，以便与以前的工作进行比较。我们鼓励社区公开发布工具、基准和实验设置，供任何人复制结果并以此为基础。

## 基准

### 专业的模糊器

​		我们如何评价专业的模糊器？有些程序采用结构化输入，有些程序采用非结构化输入。有的程序有状态，有的无状态。有源代码可用的程序，也有只有编译过的二进制文件可用的程序。有些程序通过文件、GUI或API接受输入。将模糊测试扩展到不同类型的软件系统是一项关键的技术挑战。

​		类似地，一些模糊器专门用于特定目的。例如，有一些模糊器试图到达程序位置，或者专注于暴露特定类型的错误，例如性能错误。

​		然而，现有的基准往往不是为这些专门任务设计的。如果没有先前的工作，我们需要研究人员选择合适的主题方案和基线的标准来进行比较。

### 防止过拟合

​		我们如何防止过度拟合特定的基准？对于任何基准套件，总是存在过度拟合的危险。尽管在基准科目上表现出优势，一个模糊器在总体上来看仍有可能是差的。缓解过度拟合的合理策略是什么？我们能否提出一个公平和健全的政策来收集基准？我们如何避免只由一个团队提供，并且可能会给一组人不适当控制的“单一来源”类型的基准？

​		模糊测试工具的竞赛可能是解决“评估”和“防止过拟合”挑战的一部分。受约束求解和验证竞赛启发的一种模型具有不同的竞争类别，如基于覆盖的模糊、有向模糊等。在每个类别中，可以根据模糊器适合的bug类型和应用程序进行进一步的划分。工具构建者可以提交自己的基准和模糊器，这将允许对整个过程进行独立审查。TestComp是一个现有的竞赛项目，说明了这一模式。

​		第二种模式是以带有bug程序的形式提出挑战性问题，并让工具开发人员直接应用模糊器来发现隐藏的bug。这有利于工具开发人员以最佳方式为每个任务配置工具，但使结果的独立再现更具挑战性。Rode0Day是一个现有的比赛，说明了这一模式。

​		另一种方法是连续评估，其中模糊器被反复用于模糊真实程序。例如，作为我们湘南会议的一个具体成果，谷歌开发了FuzzBench，并投入了计算资源来评估提交的fuzzer。除了对技术进步进行科学评估外，该方法还允许将这些技术进步直接应用于大量实际的开源软件，以使关键软件系统更安全。

## 模糊器的性能测量

​		在评估两种模糊技术时，我们应该比较哪些数量？我们衡量什么？今天，模糊器通常根据其有效性和效率进行评估。当我们对安全漏洞感兴趣时，模糊器对软件系统的有效性取决于模糊器能够发现的漏洞总数。相比之下，软件系统的模糊器效率取决于漏洞被发现的速度。

### 人为合成的bug

​		为了进行评估，只需将人工故障注入现有系统，就可以有效地生成有缺陷的软件系统。我们需要从经验上研究这种合成漏洞是否确实代表了真实和重要的安全漏洞。如果它们不具有代表性，它们与实际漏洞有什么不同？我们能做些什么让合成bug更像真实bug？哪些类型的漏洞未在合成错误基准测试中表示？

### 真实的bug

​		先前使用其他模糊器发现的真正的bug是否具有代表性？另一种方法是将通过其他方式发现的实际漏洞收集到基准中。然而，这个过程是繁琐的，因此样本量可能相对较小，这将影响结果的一般性。其次，评估只确定新提出的模糊器至少发现了以前发现的相同漏洞。它没有评估新提出的模糊器发现新漏洞的程度。所有（未发现）漏洞中发现的漏洞的代表性如何？我们可以在许多软件系统中建立一个大型的、共享的漏洞数据库，这些漏洞在一段时间内被几个模糊器或安全审计员发现。

### 覆盖率

​		覆盖率是衡量模糊测试效果的好方法吗？当没有合适的bug基准时，我们需要其他方法来评估模糊器的有效性。代码覆盖率是经典的替代度量。直**觉是，如果包含漏洞的代码从未被执行，则无法暴露漏洞**。覆盖率在衡量模糊器暴露漏洞的能力方面到底有多有效？**我们需要实证研究来评估不同覆盖率指标的增加与发现漏洞的概率增加之间的相关性**。除了代码覆盖率，还有许多其他覆盖率度量，如GUI、约束、模型、语法或状态覆盖率。我们应该进行实证研究，以确定各种代理有效性度量的相关性和一致性

### 时间预算

​		什么是合理的时间预算选择？直接测量模糊器的有效性是不可能的。如果我们的度量是发现的错误的数量，那么有效性就是模糊器在极限内发现的错误总数，即当给定无限时间时。相反，**研究人员可以通过固定时间预算，得出有效性的一个微不足道的下限，即模糊器发现的错误总数目前，这个时间预算通常在一小时到一天之间。**目前，这个时间预算通常在一小时到一天之间。然而，一个非常有效的模糊器可能需要一些时间来生成测试用例，在此期间，另一个模糊器可以生成几个数量级的测试用例。如果选择的时间预算太小，则越快，但效果越差，模糊器可能会显得更有效。因此，我们应该制定标准，以便在评估模糊器的有效性时公平选择时间预算。

## 技术与实现

### 技术评估

​		我们如何评估技术而不是实现？为了证明提出的技术的优越性，研究人员将提出的技术与现有技术的实现进行了比较。在实现过程中，研究人员可以做出工程决策，从而对模糊器的有效性产生重大影响。例如，AFL灰盒模糊器与KLEE白盒模糊器之间的比较，以确定白盒模糊技术是否优于灰盒模糊技术，应该始终保持谨慎。如果可能，所提出的技术（例如，对灰盒模糊化的改进）被直接实现到基线（例如，AFL）中。

## 调查

​		为了请求更大的社区对已确定的挑战提供反馈，我们调查了来自行业和学术界的更多专家。我们的目标是确定争论点，增加我们可能忽略的挑战或反思，并为一些已确定的挑战寻求具体途径或举措。我们向软件安全专家发送了一封电子邮件邀请，他们以前发表过模糊或在自动漏洞发现方面有专业工作。在24名受访者中，14人在学术界工作，10人在工业界工作；三人参加了湘南会议。

​		调查参与者将改进自动化（71%）、建立模糊化理论（63%）和找到有效的模糊器性能衡量标准（63%）作为他们最重要的三大挑战。虽然从业者和研究人员基本一致，**但从业者对人机回环方法的发展表现出了更大的兴趣**(+0.8 Likert points)。平均而言，一名受访者在5分利克特量表上将所有确定的挑战标记为重要或非常重要。未发现其他重大挑战。其他调查结果直接添加到相应的章节中。

​		模糊测试在今天的公司中以一种重要的方式被使用，基本上每天都会被用于检测bug和安全漏洞。尽管在静态分析和形式验证方面取得了进步，但模糊仍然是大多数软件产品中漏洞发现的主要自动机制。然而，我们软件系统的安全掌握在每一位软件工程师的手中，包括未来为关键开源软件做出贡献的志愿者。我们认为，无论是小的还是大的，意识和教育都至关重要。

​		一种机制是组织面向安全的黑客马拉松和夺旗比赛。例如，来自马里兰州的“构建-打破-修复”竞赛就代表了这一方向的早期成功尝试。社区也可以在模糊工具之间进行竞争，或者组织定期的模糊训练营。
​		另一个机制是在软件工程和网络安全课程中教授模糊。第二位和第三位作者积极参与了大学一级此类课程的设计和提供。开发此类教育内容的一个关键挑战是，学生需要接触多种工具，这占用了学生大量的时间。最近在线图书的发展可以通过提供一个集成的资源和存储库来缓解其中的一些问题，以熟悉模糊化的各种变体。

## 致谢

​		我们感谢关于模糊和符号执行的湘南会议的参与者和调查受访者。这项工作由澳大利亚研究委员会通过发现早期职业研究者奖（DE190100046）部分资助。该项目已获得欧盟地平线2020研究与创新计划（拨款协议819141）下的欧洲研究委员会资助，并通过拨款EP/R011605/1获得英国工程与物理科学研究委员会资助。这项工作得到了值得信赖的软件系统国家卓越卫星的部分支持，并由新加坡国家研究基金会在国家网络安全研发计划下资助。

